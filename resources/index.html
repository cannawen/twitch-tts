<html>
  <head>
    <title>HK's twitch TTS service</title>
    <script>
      let timeoutId;

      function pollMessage() {
        return fetch("/poll")
          .then((res) => res.json())
          .then((res) => {
            return new Promise((resolve) => {
              const message = res.message;
              if (message) {
                const synth = window.speechSynthesis;
                const voices = synth.getVoices();
                const utterance = new SpeechSynthesisUtterance(message);

                document.getElementById("message").innerText = message;

                utterance.voice = voices.find(
                  (voice) => voice.name === "Daniel"
                );
                synth.speak(utterance);
                utterance.addEventListener("end", (evt) => {
                  resolve();
                });
              } else {
                resolve();
              }
            });
          });
      }

      function loop() {
        try {
          pollMessage().then(() => {
            timeoutId = setTimeout(loop, 500);
          });
        } catch (error) {
          loop();
        }
      }

      function start() {
        loop();
        document.getElementById("start").style.display = "none";
      }
    </script>
  </head>
  <body>
    <button
      id="start"
      onClick="start()"
      style="font-size: 3em; cursor: pointer"
    >
      START TTS
    </button>
    <div id="message"></div>
  </body>
</html>
